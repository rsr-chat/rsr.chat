"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[3948],{8335(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"proto/extensions/did-sasl","title":"rsr.chat/did-sasl","description":"This specification is still a draft and is subject to change at any time.","source":"@site/content/proto/1500_extensions/did-sasl.md","sourceDirName":"proto/1500_extensions","slug":"/proto/extensions/did-sasl","permalink":"/docs/proto/extensions/did-sasl","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"rsr.chat/did-sasl"},"sidebar":"protoSidebar","previous":{"title":"rsr.chat/channel-pins","permalink":"/docs/proto/extensions/channel-pins"},"next":{"title":"rsr.chat/did-signing","permalink":"/docs/proto/extensions/did-signing"}}');var t=i(4848),d=i(8453);const r={title:"rsr.chat/did-sasl"},l="rsr.chat/sasl-did",c={},a=[{value:"Motivation",id:"motivation",level:2},{value:"Capability",id:"capability",level:2},{value:"ISUPPORT Tokens",id:"isupport-tokens",level:2},{value:"Two Signing Flows",id:"two-signing-flows",level:2},{value:"Direct Flow",id:"direct-flow",level:3},{value:"Delegate Flow",id:"delegate-flow",level:3},{value:"Pre-Issued Challenges",id:"pre-issued-challenges",level:2},{value:"DIDCHALLENGE REQUEST",id:"didchallenge-request",level:3},{value:"DIDCHALLENGE CANCEL",id:"didchallenge-cancel",level:3},{value:"Numerics",id:"numerics",level:3},{value:"SASL Mechanism: RSR-DID-WEB and RSR-DID-PLC",id:"sasl-mechanism-rsr-did-web-and-rsr-did-plc",level:2},{value:"Step 1: Client Initial Message",id:"step-1-client-initial-message",level:3},{value:"Step 2: Server Challenge Message",id:"step-2-server-challenge-message",level:3},{value:"Step 3: Client Response",id:"step-3-client-response",level:3},{value:"Server Verification",id:"server-verification",level:3},{value:"OAuth Delegation",id:"oauth-delegation",level:2},{value:"Overview",id:"overview",level:3},{value:"DID Document Convention for Delegated Signing",id:"did-document-convention-for-delegated-signing",level:3},{value:"OAuth 2.0 Signing Flow",id:"oauth-20-signing-flow",level:3},{value:"1. Obtain a Signing Token via OAuth 2.0 with PKCE",id:"1-obtain-a-signing-token-via-oauth-20-with-pkce",level:4},{value:"2. Exchange the Token for a Signature",id:"2-exchange-the-token-for-a-signature",level:4},{value:"3. Present the JWS to the IRC Server",id:"3-present-the-jws-to-the-irc-server",level:4},{value:"Non-Interactive Delegate Flow",id:"non-interactive-delegate-flow",level:3},{value:"did and AT Protocol PDS Signing",id:"did-and-at-protocol-pds-signing",level:3},{value:"DID Method Support",id:"did-method-support",level:2},{value:"did",id:"did",level:3},{value:"did",id:"did-1",level:3},{value:"Supported Algorithms",id:"supported-algorithms",level:2},{value:"Resolution and Validation",id:"resolution-and-validation",level:2},{value:"DID Document Requirements",id:"did-document-requirements",level:3},{value:"Resolution Security",id:"resolution-security",level:3},{value:"Caching",id:"caching",level:3},{value:"Account Association",id:"account-association",level:2},{value:"WHOIS Integration",id:"whois-integration",level:2},{value:"Key Rotation",id:"key-rotation",level:2},{value:"Guild Integration",id:"guild-integration",level:2},{value:"Channel Membership Integration",id:"channel-membership-integration",level:2},{value:"RBAC Integration",id:"rbac-integration",level:2},{value:"Advanced Moderation Integration",id:"advanced-moderation-integration",level:2},{value:"Error Handling Summary",id:"error-handling-summary",level:2},{value:"Security Considerations",id:"security-considerations",level:2},{value:"Nonce Freshness",id:"nonce-freshness",level:3},{value:"Challenge Binding",id:"challenge-binding",level:3},{value:"aud Binding",id:"aud-binding",level:3},{value:"Delegate Flow Considerations",id:"delegate-flow-considerations",level:3},{value:"DID Document Injection",id:"did-document-injection",level:3},{value:"Key Compromise",id:"key-compromise",level:3},{value:"Examples",id:"examples",level:2},{value:"Direct flow: DID-WEB",id:"direct-flow-did-web",level:3},{value:"Delegate flow: DID-PLC via AT Protocol PDS",id:"delegate-flow-did-plc-via-at-protocol-pds",level:3},{value:"Pre-issued challenge cancelled after failed OAuth flow",id:"pre-issued-challenge-cancelled-after-failed-oauth-flow",level:3},{value:"WHOIS showing authenticated DID and flow",id:"whois-showing-authenticated-did-and-flow",level:3},{value:"Resolution failure during DIDCHALLENGE REQUEST",id:"resolution-failure-during-didchallenge-request",level:3},{value:"Expired pre-issued challenge presented in SASL",id:"expired-pre-issued-challenge-presented-in-sasl",level:3},{value:"Challenge presented on wrong connection",id:"challenge-presented-on-wrong-connection",level:3}];function o(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.admonition,{type:"warning",children:(0,t.jsxs)(n.p,{children:["This specification is still a ",(0,t.jsx)(n.strong,{children:"draft"})," and is subject to change at any time."]})}),"\n",(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"rsrchatsasl-did",children:"rsr.chat/sasl-did"})}),"\n",(0,t.jsxs)(n.p,{children:["This extension defines two SASL authentication mechanisms, ",(0,t.jsx)(n.code,{children:"RSR-DID-WEB"})," and ",(0,t.jsx)(n.code,{children:"RSR-DID-PLC"}),", that\nallow clients to authenticate to IRC servers using W3C Decentralised Identifiers. Both\nmechanisms use a server-issued challenge and a client-produced JSON Web Signature over\nthat challenge. The signature need not be produced inline during the SASL\nexchange: clients may pre-request a challenge, complete an OAuth 2.0 delegated signing\nflow with a provider that holds their key, and present the resulting signature in a\nsubsequent SASL exchange. The server validates the signature against the DID document\nregardless of how the client obtained it."]}),"\n",(0,t.jsx)(n.h2,{id:"motivation",children:"Motivation"}),"\n",(0,t.jsxs)(n.p,{children:["DID-based authentication allows users to authenticate using an identity they control\nindependently of the IRC network \u2014 rooted in a web domain they own (",(0,t.jsx)(n.code,{children:"did:web"}),") or in the\nAT Protocol PLC directory (",(0,t.jsx)(n.code,{children:"did:plc"}),"). However, not all clients hold private key material\ndirectly. A user may delegate key custody to an OAuth-capable signing provider: an\nidentity wallet, an AT Protocol PDS, a hardware security device fronted by an API, or a\nbrowser-based key store. Supporting these delegated signing arrangements requires\ndecoupling challenge issuance from the SASL exchange so that an interactive OAuth flow\ncan complete before the client presents its response. This specification supports both\ndirect signing (client holds the key) and delegated signing (client obtains a signature\nfrom an OAuth provider) under the same mechanism names, with the server indifferent to\nwhich path the client took."]}),"\n",(0,t.jsx)(n.h2,{id:"capability",children:"Capability"}),"\n",(0,t.jsxs)(n.p,{children:["This extension supplements but does not replace the IRCv3 ",(0,t.jsx)(n.code,{children:"sasl"})," capability and MUST\nonly be offered when ",(0,t.jsx)(n.code,{children:"sasl"})," is also available."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"CAP * LS :sasl=PLAIN,RSR-DID-WEB,RSR_DID-PLC\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Clients that wish to authenticate via a DID method MUST negotiate ",(0,t.jsx)(n.code,{children:"sasl"})," and use the\n",(0,t.jsx)(n.code,{children:"AUTHENTICATE"})," command with the mechanism name ",(0,t.jsx)(n.code,{children:"RSR-DID-WEB"})," or ",(0,t.jsx)(n.code,{children:"RSR-DID-PLC"})," as appropriate."]}),"\n",(0,t.jsx)(n.h2,{id:"isupport-tokens",children:"ISUPPORT Tokens"}),"\n",(0,t.jsxs)(n.p,{children:["Servers MUST advertise the following tokens in ",(0,t.jsx)(n.code,{children:"RPL_ISUPPORT"})," (005) when this capability\nis active:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"DIDDNSTIMEOUT=<ms>"})," \u2014 the maximum time in milliseconds the server will wait for DID\ndocument resolution. Recommended default: ",(0,t.jsx)(n.code,{children:"5000"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"DIDNONCELEN=<n>"})," \u2014 the byte length of server-generated nonces. Servers MUST NOT\nenforce a value lower than 32."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"DIDCACHETTL=<s>"})," \u2014 seconds for which the server MAY cache a resolved DID document.\n",(0,t.jsx)(n.code,{children:"0"})," means no caching."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"DIDINLINETTL=<s>"})," \u2014 seconds before an inline SASL challenge expires. Recommended\ndefault: ",(0,t.jsx)(n.code,{children:"60"}),". This is the window available to direct-signing clients."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"DIDPREISSUETTL=<s>"})," \u2014 seconds before a pre-issued challenge expires. Recommended\ndefault: ",(0,t.jsx)(n.code,{children:"600"})," (10 minutes). This is the window available to clients completing an\nOAuth flow."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"DIDALGS=<alg1>,<alg2>,..."})," \u2014 supported JWS algorithm identifiers, in server\npreference order."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:":server 005 nick DIDDNSTIMEOUT=5000 DIDNONCELEN=32 DIDCACHETTL=300 DIDINLINETTL=60 DIDPREISSUETTL=600 DIDALGS=EdDSA,ES256K,ES256 :are supported by this server\n"})}),"\n",(0,t.jsx)(n.h2,{id:"two-signing-flows",children:"Two Signing Flows"}),"\n",(0,t.jsxs)(n.p,{children:["Both ",(0,t.jsx)(n.code,{children:"RSR-DID-WEB"})," and ",(0,t.jsx)(n.code,{children:"RSR-DID-PLC"})," support two signing flows, declared by the client in its\ninitial SASL message. The server's behaviour during verification is identical in both\ncases; the flow distinction affects only challenge issuance timing and TTL."]}),"\n",(0,t.jsx)(n.h3,{id:"direct-flow",children:"Direct Flow"}),"\n",(0,t.jsxs)(n.p,{children:["The client holds the private key locally. The challenge is issued inline during the SASL\nexchange and expires after ",(0,t.jsx)(n.code,{children:"DIDINLINETTL"})," seconds. This is appropriate for clients with\ndirect access to key material."]}),"\n",(0,t.jsx)(n.h3,{id:"delegate-flow",children:"Delegate Flow"}),"\n",(0,t.jsxs)(n.p,{children:["The client does not hold the private key directly and will obtain a signature from an\nexternal OAuth-capable signing provider. To accommodate the interactive OAuth exchange,\nthe client pre-requests a challenge before starting SASL using the ",(0,t.jsx)(n.code,{children:"DIDCHALLENGE"})," command\n(see Pre-Issued Challenges). The pre-issued challenge expires after ",(0,t.jsx)(n.code,{children:"DIDPREISSUETTL"}),"\nseconds. During the SASL exchange the client references the pre-issued challenge by its\nID rather than waiting for an inline challenge."]}),"\n",(0,t.jsx)(n.p,{children:"The server does not participate in the OAuth exchange and does not communicate with the\nsigning provider. From the server's perspective, a delegate flow is simply a SASL\nexchange in which the client presents a pre-computed JWS referencing a previously issued\nchallenge."}),"\n",(0,t.jsx)(n.h2,{id:"pre-issued-challenges",children:"Pre-Issued Challenges"}),"\n",(0,t.jsx)(n.h3,{id:"didchallenge-request",children:"DIDCHALLENGE REQUEST"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"DIDCHALLENGE REQUEST <did>\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Requests a challenge for the given DID without beginning SASL. The server resolves the\nDID document (see Resolution and Validation) and, if resolution succeeds, issues a\nchallenge with a TTL of ",(0,t.jsx)(n.code,{children:"DIDPREISSUETTL"})," seconds."]}),"\n",(0,t.jsxs)(n.p,{children:["The server replies with ",(0,t.jsx)(n.code,{children:"RPL_DIDCHALLENGE"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:":server RPL_DIDCHALLENGE <nick> <challenge-id> <did> :<challenge-json-base64>\n"})}),"\n",(0,t.jsx)(n.p,{children:"Where:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"challenge-id"})," is a server-generated opaque identifier for this pre-issued challenge,\ndistinct from the nonce. Clients include this ID in their SASL initial message to\nindicate they are responding to a pre-issued challenge."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"challenge-json-base64"})," is the base64-encoded challenge JSON, identical in structure\nto the inline challenge (see Server Challenge Message)."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Pre-issued challenges are bound to the connection that requested them. A challenge issued\non one connection MUST NOT be accepted on a different connection."}),"\n",(0,t.jsx)(n.h3,{id:"didchallenge-cancel",children:"DIDCHALLENGE CANCEL"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"DIDCHALLENGE CANCEL <challenge-id>\n"})}),"\n",(0,t.jsx)(n.p,{children:"Cancels a pre-issued challenge. The server MUST discard the challenge immediately. This\nSHOULD be called by the client if the OAuth flow fails or is abandoned, so that the\nserver can free the associated state."}),"\n",(0,t.jsx)(n.h3,{id:"numerics",children:"Numerics"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Symbolic name"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"RPL_DIDCHALLENGE"}),(0,t.jsx)(n.td,{children:"A pre-issued challenge"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"ERR_DIDCHALLENGEFAIL"}),(0,t.jsx)(n.td,{children:"Challenge could not be issued (resolution failure, etc.)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"ERR_DIDCHALLENGEUNKNOWN"}),(0,t.jsx)(n.td,{children:"The referenced challenge-id is not known or has expired"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"sasl-mechanism-rsr-did-web-and-rsr-did-plc",children:"SASL Mechanism: RSR-DID-WEB and RSR-DID-PLC"}),"\n",(0,t.jsx)(n.p,{children:"The two mechanisms are identical in message structure. The mechanism name determines\nwhich DID resolution method the server uses."}),"\n",(0,t.jsx)(n.h3,{id:"step-1-client-initial-message",children:"Step 1: Client Initial Message"}),"\n",(0,t.jsxs)(n.p,{children:["After sending ",(0,t.jsx)(n.code,{children:"AUTHENTICATE RSR-DID-WEB"})," or ",(0,t.jsx)(n.code,{children:"RSR-AUTHENTICATE DID-PLC"})," the server sends\n",(0,t.jsx)(n.code,{children:"AUTHENTICATE +"}),". The client then sends its initial message as a base64-encoded JSON\nobject:"]}),"\n",(0,t.jsxs)(n.p,{children:["For a ",(0,t.jsx)(n.strong,{children:"direct flow"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "flow": "direct",\n  "did": "<the client\'s full DID string>",\n  "vmId": "<verification method ID>"\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["For a ",(0,t.jsx)(n.strong,{children:"delegate flow"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "flow": "delegate",\n  "did": "<the client\'s full DID string>",\n  "vmId": "<verification method ID>",\n  "challengeId": "<the challenge-id from a prior DIDCHALLENGE REQUEST>"\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"Fields:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"flow"})," \u2014 MUST be ",(0,t.jsx)(n.code,{children:"direct"})," or ",(0,t.jsx)(n.code,{children:"delegate"}),". Absent field MUST be treated as ",(0,t.jsx)(n.code,{children:"direct"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"did"})," \u2014 MUST be a syntactically valid DID matching the mechanism's method. A\n",(0,t.jsx)(n.code,{children:"DID-WEB"})," exchange MUST present a ",(0,t.jsx)(n.code,{children:"did:web:..."})," DID; ",(0,t.jsx)(n.code,{children:"DID-PLC"})," MUST present a\n",(0,t.jsx)(n.code,{children:"did:plc:..."})," DID. Method mismatch MUST cause the server to abort with ERR_SASLFAIL."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"vmId"})," \u2014 the ",(0,t.jsx)(n.code,{children:"id"})," of the verification method in the DID document the client will use\nto sign. The server confirms this method exists and appears under ",(0,t.jsx)(n.code,{children:"authentication"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"challengeId"})," \u2014 delegate flow only. MUST reference a pre-issued challenge obtained\nvia ",(0,t.jsx)(n.code,{children:"DIDCHALLENGE REQUEST"})," on this connection. If absent in a delegate flow, or if\nthe referenced challenge has expired or is unknown, the server MUST abort with\nERR_SASLFAIL."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"step-2-server-challenge-message",children:"Step 2: Server Challenge Message"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Direct flow"}),": The server issues a fresh challenge with TTL ",(0,t.jsx)(n.code,{children:"DIDINLINETTL"})," and sends\nit as a base64-encoded JSON object via ",(0,t.jsx)(n.code,{children:"AUTHENTICATE"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "challengeId": null,\n  "nonce": "<DIDNONCELEN random bytes, base64url-encoded>",\n  "did": "<the DID the server resolved, echoed>",\n  "vmId": "<the vmId echoed>",\n  "ts": "<ISO 8601 UTC timestamp of challenge issuance>",\n  "ttl": <DIDINLINETTL value in seconds>\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Delegate flow"}),": The server has already sent the challenge via RPL_DIDCHALLENGE. It\nechoes the challenge ID to confirm it is accepted and proceeds immediately to await the\nclient response:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "challengeId": "<the challenge-id>",\n  "nonce": "<nonce from the pre-issued challenge, verbatim>",\n  "did": "<did echoed>",\n  "vmId": "<vmId echoed>",\n  "ts": "<ts from the pre-issued challenge, verbatim>",\n  "ttl": <remaining TTL in seconds at time of SASL initiation>\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["In both cases the client MUST verify that the echoed ",(0,t.jsx)(n.code,{children:"did"})," and ",(0,t.jsx)(n.code,{children:"vmId"})," match its request\nbefore signing."]}),"\n",(0,t.jsx)(n.h3,{id:"step-3-client-response",children:"Step 3: Client Response"}),"\n",(0,t.jsx)(n.p,{children:"The client produces a JSON Web Signature (JWS, RFC 7515) in Compact Serialisation form\nover the following payload and sends the result base64-encoded:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "did": "<the client\'s DID>",\n  "vmId": "<the verification method ID>",\n  "nonce": "<the nonce from the challenge, verbatim>",\n  "ts": "<the ts from the challenge, verbatim>",\n  "aud": "<the server\'s hostname as presented in the 001 welcome message>",\n  "flow": "<direct or delegate>"\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"In a direct flow the client signs this payload with its locally held private key."}),"\n",(0,t.jsx)(n.p,{children:"In a delegate flow the client passes this payload to its OAuth signing provider and\nreceives a signed JWS in return (see OAuth Delegation). The JWS presented to the server\nis the one returned by the provider, not one produced by the client itself."}),"\n",(0,t.jsx)(n.p,{children:"In either case:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["The JWS ",(0,t.jsx)(n.code,{children:"alg"})," header MUST be one of the algorithms listed in ",(0,t.jsx)(n.code,{children:"DIDALGS"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["The JWS ",(0,t.jsx)(n.code,{children:"kid"})," header MUST be set to ",(0,t.jsx)(n.code,{children:"vmId"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["The server MUST verify the ",(0,t.jsx)(n.code,{children:"aud"})," claim matches its own hostname."]}),"\n",(0,t.jsxs)(n.li,{children:["The server MUST verify the ",(0,t.jsx)(n.code,{children:"nonce"})," and ",(0,t.jsx)(n.code,{children:"ts"})," match the issued challenge."]}),"\n",(0,t.jsx)(n.li,{children:"The server MUST verify the challenge has not expired."}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"server-verification",children:"Server Verification"}),"\n",(0,t.jsx)(n.p,{children:"On receipt of the client response the server MUST:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Decode and parse the JWS."}),"\n",(0,t.jsxs)(n.li,{children:["Verify ",(0,t.jsx)(n.code,{children:"aud"})," matches the server's own hostname."]}),"\n",(0,t.jsx)(n.li,{children:"Locate the challenge (inline or pre-issued) and confirm it has not expired."}),"\n",(0,t.jsxs)(n.li,{children:["Verify the ",(0,t.jsx)(n.code,{children:"nonce"})," and ",(0,t.jsx)(n.code,{children:"ts"})," in the payload match the challenge verbatim."]}),"\n",(0,t.jsxs)(n.li,{children:["Locate the verification method identified by ",(0,t.jsx)(n.code,{children:"vmId"})," in the resolved DID document."]}),"\n",(0,t.jsxs)(n.li,{children:["Verify the located method appears in the ",(0,t.jsx)(n.code,{children:"authentication"})," verification relationship."]}),"\n",(0,t.jsx)(n.li,{children:"Extract the public key material from the verification method."}),"\n",(0,t.jsx)(n.li,{children:"Validate the JWS signature against the payload using the extracted key."}),"\n",(0,t.jsx)(n.li,{children:"Consume the nonce; it MUST NOT be accepted again."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"If all checks pass the server completes authentication with RPL_SASLSUCCESS (903). If any\ncheck fails the server MUST reply with ERR_SASLFAIL (904) and MUST NOT disclose which\nspecific check failed."}),"\n",(0,t.jsx)(n.h2,{id:"oauth-delegation",children:"OAuth Delegation"}),"\n",(0,t.jsx)(n.p,{children:"This section describes the client-side OAuth delegation pattern. The server does not\nparticipate in this flow and requires no OAuth-specific configuration."}),"\n",(0,t.jsx)(n.h3,{id:"overview",children:"Overview"}),"\n",(0,t.jsx)(n.p,{children:"In the delegate flow, the user's private key is held by an OAuth-capable signing\nprovider rather than the client. The DID document's verification method references the\nprovider's public key (or a key the provider holds on the user's behalf). The client:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Pre-requests a challenge from the IRC server via ",(0,t.jsx)(n.code,{children:"DIDCHALLENGE REQUEST"}),"."]}),"\n",(0,t.jsx)(n.li,{children:"Authenticates to the signing provider via an OAuth 2.0 flow."}),"\n",(0,t.jsx)(n.li,{children:"Requests the provider to sign the JWS payload containing the IRC nonce."}),"\n",(0,t.jsx)(n.li,{children:"Receives the signed JWS from the provider."}),"\n",(0,t.jsx)(n.li,{children:"Presents the JWS to the IRC server via SASL."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"The signing provider sees and signs the IRC nonce but does not communicate with the IRC\nserver directly. The IRC server sees and verifies a JWS but does not communicate with\nthe provider. The client mediates between the two."}),"\n",(0,t.jsx)(n.h3,{id:"did-document-convention-for-delegated-signing",children:"DID Document Convention for Delegated Signing"}),"\n",(0,t.jsxs)(n.p,{children:["Verification methods that represent keys held by a signing provider SHOULD include a\n",(0,t.jsx)(n.code,{children:"serviceEndpoint"})," property pointing to the provider's signing API. This is a convention\nfor client discovery; the server does not read or validate it:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "id": "did:web:alice.example.com#key-oauth-1",\n  "type": "JsonWebKey2020",\n  "controller": "did:web:alice.example.com",\n  "publicKeyJwk": { ... },\n  "serviceEndpoint": "https://wallet.example.com/sign"\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Clients that discover a ",(0,t.jsx)(n.code,{children:"serviceEndpoint"})," on the target verification method SHOULD use\nit as the signing API endpoint for the delegate flow. Clients MUST NOT transmit the\n",(0,t.jsx)(n.code,{children:"serviceEndpoint"})," to the IRC server."]}),"\n",(0,t.jsx)(n.h3,{id:"oauth-20-signing-flow",children:"OAuth 2.0 Signing Flow"}),"\n",(0,t.jsx)(n.p,{children:"The specific OAuth grant type and API shape are defined by the signing provider. The\nfollowing is a RECOMMENDED approach that client and provider authors SHOULD follow for\ninteroperability."}),"\n",(0,t.jsx)(n.h4,{id:"1-obtain-a-signing-token-via-oauth-20-with-pkce",children:"1. Obtain a Signing Token via OAuth 2.0 with PKCE"}),"\n",(0,t.jsxs)(n.p,{children:["The client initiates a standard OAuth 2.0 authorisation code flow (RFC 6749) with PKCE\n(RFC 7636) against the provider's authorisation server. The requested scope SHOULD\ninclude a provider-defined scope that grants signing permission, e.g. ",(0,t.jsx)(n.code,{children:"irc:sign"})," or\n",(0,t.jsx)(n.code,{children:"did:sign"}),". For non-interactive clients with pre-established credentials a client\ncredentials grant MAY be used instead."]}),"\n",(0,t.jsx)(n.p,{children:"Clients and providers that support OAuth 2.0 Pushed Authorisation Requests (PAR,\nRFC 9126) SHOULD use PAR to bind the IRC challenge nonce to the authorisation request,\nproviding an additional binding between the OAuth flow and the IRC challenge:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'POST /oauth/par\n{\n  "client_id": "...",\n  "response_type": "code",\n  "scope": "irc:sign",\n  "code_challenge": "...",\n  "code_challenge_method": "S256",\n  "irc_challenge_nonce": "<the nonce from the IRC server>"\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["The authorisation server MAY display the ",(0,t.jsx)(n.code,{children:"irc_challenge_nonce"})," and the IRC server\nhostname to the user during the consent screen so they can verify what they are\nauthorising."]}),"\n",(0,t.jsx)(n.h4,{id:"2-exchange-the-token-for-a-signature",children:"2. Exchange the Token for a Signature"}),"\n",(0,t.jsx)(n.p,{children:"After obtaining an access token the client calls the provider's signing endpoint with\nthe JWS payload to be signed:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-http",children:'POST /sign\nAuthorization: DPoP <access-token>\nContent-Type: application/json\n\n{\n  "vmId": "<the verification method ID>",\n  "payload": {\n    "did": "...",\n    "vmId": "...",\n    "nonce": "...",\n    "ts": "...",\n    "aud": "...",\n    "flow": "delegate"\n  }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"DPoP (RFC 9449) is RECOMMENDED for binding the access token to the signing request and\npreventing token exfiltration. Providers that support DPoP MUST require it for signing\nrequests."}),"\n",(0,t.jsxs)(n.p,{children:["The provider signs the payload with the private key corresponding to ",(0,t.jsx)(n.code,{children:"vmId"}),", constructs\nthe JWS in Compact Serialisation, and returns it:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "jws": "<header>.<payload>.<signature>"\n}\n'})}),"\n",(0,t.jsx)(n.h4,{id:"3-present-the-jws-to-the-irc-server",children:"3. Present the JWS to the IRC Server"}),"\n",(0,t.jsx)(n.p,{children:"The client uses the returned JWS as its SASL response in Step 3 of the SASL exchange.\nThe IRC server has no knowledge that the JWS was produced by a provider rather than the\nclient and validates it identically."}),"\n",(0,t.jsx)(n.h3,{id:"non-interactive-delegate-flow",children:"Non-Interactive Delegate Flow"}),"\n",(0,t.jsxs)(n.p,{children:["For automated clients that have a pre-established API relationship with a signing\nprovider (e.g. a bot whose key is managed by a secrets manager), the PKCE flow is\nunnecessary. Such clients MAY use a client credentials grant or API key to obtain a\nsigning token and call the signing endpoint programmatically. Provided the total time\nstays within ",(0,t.jsx)(n.code,{children:"DIDPREISSUETTL"})," seconds this is operationally transparent."]}),"\n",(0,t.jsxs)(n.h3,{id:"did-and-at-protocol-pds-signing",children:["did",":plc"," and AT Protocol PDS Signing"]}),"\n",(0,t.jsxs)(n.p,{children:["Users with a ",(0,t.jsx)(n.code,{children:"did:plc"})," identity whose key is managed by an AT Protocol PDS SHOULD use\nthe PDS's OAuth 2.0 interface as the signing provider. AT Protocol PDSes that implement\nthe AT Protocol OAuth specification expose a signing endpoint compatible with the\ndelegate flow described here. The PDS verification method in the DID document references\nthe PDS-held key, and the PDS signs the IRC challenge after the user authorises the\nrequest via the standard AT Protocol OAuth consent flow."]}),"\n",(0,t.jsxs)(n.p,{children:["Clients that target AT Protocol PDSes SHOULD use PAR with the ",(0,t.jsx)(n.code,{children:"irc_challenge_nonce"}),"\nextension to bind the authorisation request to the IRC challenge. The PDS's OAuth server\nSHOULD surface the IRC server hostname and challenge timestamp on its consent screen."]}),"\n",(0,t.jsx)(n.h2,{id:"did-method-support",children:"DID Method Support"}),"\n",(0,t.jsxs)(n.h3,{id:"did",children:["did",":web"]}),"\n",(0,t.jsxs)(n.p,{children:["A ",(0,t.jsx)(n.code,{children:"did:web"})," DID document is retrieved from an HTTPS endpoint derived from the DID:"]}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"DID"}),(0,t.jsx)(n.th,{children:"Document URL"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"did:web:example.com"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"https://example.com/.well-known/did.json"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"did:web:example.com:users:alice"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"https://example.com/users/alice/did.json"})})]})]})]}),"\n",(0,t.jsx)(n.p,{children:"Servers MUST use HTTPS. Servers MUST NOT follow redirects to non-HTTPS endpoints. TLS\ncertificates MUST be validated. Non-200 responses and malformed JSON MUST fail with\nERR_SASLFAIL."}),"\n",(0,t.jsxs)(n.h3,{id:"did-1",children:["did",":plc"]}),"\n",(0,t.jsxs)(n.p,{children:["A ",(0,t.jsx)(n.code,{children:"did:plc"})," DID document is retrieved from:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"https://plc.directory/<did>\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Servers MUST use the canonical PLC directory. Servers MUST NOT permit clients to specify\nan alternative directory. TLS validation applies as for ",(0,t.jsx)(n.code,{children:"did:web"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"supported-algorithms",children:"Supported Algorithms"}),"\n",(0,t.jsx)(n.p,{children:"Servers MUST support:"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Algorithm"}),(0,t.jsx)(n.th,{children:"Description"}),(0,t.jsx)(n.th,{children:"Key type in DID document"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"EdDSA"})}),(0,t.jsx)(n.td,{children:"Ed25519 (RFC 8037)"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"JsonWebKey2020"})," or ",(0,t.jsx)(n.code,{children:"Ed25519VerificationKey2020"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ES256K"})}),(0,t.jsx)(n.td,{children:"ECDSA with secp256k1 (RFC 8812)"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"JsonWebKey2020"})," or ",(0,t.jsx)(n.code,{children:"EcdsaSecp256k1VerificationKey2019"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ES256"})}),(0,t.jsx)(n.td,{children:"ECDSA with P-256 (RFC 7518)"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"JsonWebKey2020"})})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:["Servers MAY support additional algorithms. ",(0,t.jsx)(n.code,{children:"EdDSA"})," (Ed25519) is RECOMMENDED. Clients\nSHOULD prefer it where their key material supports it."]}),"\n",(0,t.jsx)(n.h2,{id:"resolution-and-validation",children:"Resolution and Validation"}),"\n",(0,t.jsx)(n.h3,{id:"did-document-requirements",children:"DID Document Requirements"}),"\n",(0,t.jsx)(n.p,{children:"Before issuing any challenge (inline or pre-issued) the server MUST resolve and validate\nthe DID document. The server MUST confirm:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["The ",(0,t.jsx)(n.code,{children:"id"})," field matches the client-presented DID by exact string equality."]}),"\n",(0,t.jsxs)(n.li,{children:["A ",(0,t.jsx)(n.code,{children:"verificationMethod"})," array is present with at least one entry."]}),"\n",(0,t.jsxs)(n.li,{children:["The ",(0,t.jsx)(n.code,{children:"vmId"})," specified by the client exists within ",(0,t.jsx)(n.code,{children:"verificationMethod"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["The matching method contains ",(0,t.jsx)(n.code,{children:"publicKeyJwk"})," or ",(0,t.jsx)(n.code,{children:"publicKeyMultibase"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["The matching method is referenced from the ",(0,t.jsx)(n.code,{children:"authentication"})," array."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Failure on any condition MUST produce ERR_SASLFAIL for inline flows or\nERR_DIDCHALLENGEFAIL for pre-issued challenge requests."}),"\n",(0,t.jsx)(n.h3,{id:"resolution-security",children:"Resolution Security"}),"\n",(0,t.jsx)(n.p,{children:"Servers MUST:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Reject plain HTTP resolution."}),"\n",(0,t.jsx)(n.li,{children:"Not follow redirects that cross scheme or target private or loopback address ranges."}),"\n",(0,t.jsxs)(n.li,{children:["Enforce ",(0,t.jsx)(n.code,{children:"DIDDNSTIMEOUT"})," as a hard wall-clock deadline on the entire operation."]}),"\n",(0,t.jsx)(n.li,{children:"Reject response bodies larger than 64 KiB."}),"\n",(0,t.jsx)(n.li,{children:"Not execute active content in the response."}),"\n",(0,t.jsxs)(n.li,{children:["Prefer ",(0,t.jsx)(n.code,{children:"Content-Type: application/did+ld+json"}),"; reject other types unless explicitly\nconfigured to accept them."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"caching",children:"Caching"}),"\n",(0,t.jsxs)(n.p,{children:["If ",(0,t.jsx)(n.code,{children:"DIDCACHETTL"})," is non-zero the server MAY cache resolved documents by DID string for\nthe advertised TTL. Cached documents MUST be stored in memory only. Servers MUST NOT\ncache resolution failures. Users who have recently rotated keys SHOULD wait for the\ncache to expire before re-authenticating."]}),"\n",(0,t.jsx)(n.h2,{id:"account-association",children:"Account Association"}),"\n",(0,t.jsx)(n.p,{children:"On successful authentication the server associates the client's DID with their IRC\naccount. The following invariants MUST hold:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"A DID MAY be associated with at most one IRC account. Authentication from a DID\nalready associated with a different account MUST fail with ERR_SASLFAIL."}),"\n",(0,t.jsx)(n.li,{children:"An IRC account MAY have multiple DIDs associated, subject to a server-configured limit."}),"\n",(0,t.jsx)(n.li,{children:"Association is persistent across sessions."}),"\n",(0,t.jsx)(n.li,{children:"The authenticated DID is exposed in WHOIS (see WHOIS Integration)."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Servers MAY support automatic account creation on first successful DID authentication\nor MAY require pre-registration. If a client authenticates with a DID that has no\nassociated account and the server does not support auto-registration, the server MUST\nreturn ERR_SASLFAIL and log the DID for operator review."}),"\n",(0,t.jsx)(n.h2,{id:"whois-integration",children:"WHOIS Integration"}),"\n",(0,t.jsx)(n.p,{children:"When a client is authenticated via a DID mechanism the server MUST include the\nauthenticated DID in WHOIS via RPL_WHOISDID:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:":server RPL_WHOISDID <querier> <nick> :<did>\n"})}),"\n",(0,t.jsx)(n.p,{children:"Servers MUST include this in self-WHOIS. Servers MAY suppress it in WHOIS by other\nusers depending on server policy."}),"\n",(0,t.jsx)(n.h2,{id:"key-rotation",children:"Key Rotation"}),"\n",(0,t.jsxs)(n.p,{children:["Rotating keys in the DID document does not invalidate existing sessions. Servers MAY\nimplement a ",(0,t.jsx)(n.code,{children:"DIDSYNC"})," command or operator procedure to force re-authentication of active\nsessions, outside the scope of this specification. Clients and signing providers that\nrotate keys SHOULD re-authenticate at the next session."]}),"\n",(0,t.jsxs)(n.p,{children:["For the delegate flow, key rotation at the signing provider requires updating the\nverification method's public key in the DID document and, if applicable, its\n",(0,t.jsx)(n.code,{children:"serviceEndpoint"}),". Clients SHOULD request a fresh pre-issued challenge after a provider\nkey rotation rather than presenting a challenge resolved against a stale document."]}),"\n",(0,t.jsx)(n.h2,{id:"guild-integration",children:"Guild Integration"}),"\n",(0,t.jsxs)(n.p,{children:["When ",(0,t.jsx)(n.code,{children:"rsr.chat/guild"})," is negotiated, a user's DID serves as a portable identity anchor\nfor guild membership. Servers that support both this extension and ",(0,t.jsx)(n.code,{children:"rsr.chat/guild"})," MAY\nallow guild administrators to require DID-based authentication for guild join, rejecting\njoin attempts from accounts not authenticated via a DID mechanism."]}),"\n",(0,t.jsx)(n.h2,{id:"channel-membership-integration",children:"Channel Membership Integration"}),"\n",(0,t.jsxs)(n.p,{children:["When ",(0,t.jsx)(n.code,{children:"rsr.chat/channel-membership"})," is negotiated, persistent membership records MAY\nstore the authenticated DID alongside the account name as an informational field. This\nfield is not used for access control decisions unless ",(0,t.jsx)(n.code,{children:"rsr.chat/rbac"})," defines rules that\nreference it."]}),"\n",(0,t.jsx)(n.h2,{id:"rbac-integration",children:"RBAC Integration"}),"\n",(0,t.jsxs)(n.p,{children:["When ",(0,t.jsx)(n.code,{children:"rsr.chat/rbac"})," is negotiated, the following permission identifiers are defined:"]}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Permission identifier"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"did.auth.require"})}),(0,t.jsx)(n.td,{children:"Only DID-authenticated clients may join or post"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"did.auth.method=did:web"})}),(0,t.jsxs)(n.td,{children:["Only did",":web"," authenticated clients are permitted"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"did.auth.method=did:plc"})}),(0,t.jsxs)(n.td,{children:["Only did",":plc"," authenticated clients are permitted"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"did.auth.flow=direct"})}),(0,t.jsx)(n.td,{children:"Only direct-flow authenticated clients are permitted"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"did.auth.flow=delegate"})}),(0,t.jsx)(n.td,{children:"Only delegate-flow authenticated clients are permitted"})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:["RBAC rules using these identifiers MAY be scoped to a channel category or guild prefix\nusing the scope syntax defined by ",(0,t.jsx)(n.code,{children:"rsr.chat/channel-categories"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"advanced-moderation-integration",children:"Advanced Moderation Integration"}),"\n",(0,t.jsxs)(n.p,{children:["When ",(0,t.jsx)(n.code,{children:"rsr.chat/advanced-moderation"})," is negotiated, the following predicates are defined:"]}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Predicate"}),(0,t.jsx)(n.th,{children:"Matches when"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"did:authenticated"})}),(0,t.jsx)(n.td,{children:"The user is authenticated via any DID mechanism"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"did:method=did:web"})}),(0,t.jsxs)(n.td,{children:["The user is authenticated via did",":web"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"did:method=did:plc"})}),(0,t.jsxs)(n.td,{children:["The user is authenticated via did",":plc"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"did:flow=direct"})}),(0,t.jsx)(n.td,{children:"The user authenticated via the direct signing flow"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"did:flow=delegate"})}),(0,t.jsx)(n.td,{children:"The user authenticated via the OAuth delegate flow"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"did:domain=<domain>"})}),(0,t.jsxs)(n.td,{children:["The user's did",":web"," DID is rooted at the specified domain"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"did:value=<did>"})}),(0,t.jsx)(n.td,{children:"The user's authenticated DID matches exactly"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"error-handling-summary",children:"Error Handling Summary"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Condition"}),(0,t.jsx)(n.th,{children:"Response"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Method mismatch"}),(0,t.jsx)(n.td,{children:"ERR_SASLFAIL (904)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"DID resolution timeout"}),(0,t.jsx)(n.td,{children:"ERR_SASLFAIL or ERR_DIDCHALLENGEFAIL"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"DID document fetch non-200 or malformed"}),(0,t.jsx)(n.td,{children:"ERR_SASLFAIL or ERR_DIDCHALLENGEFAIL"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"vmId not found or not in authentication"}),(0,t.jsx)(n.td,{children:"ERR_SASLFAIL or ERR_DIDCHALLENGEFAIL"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"challengeId not found or expired"}),(0,t.jsx)(n.td,{children:"ERR_SASLFAIL (904)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"challengeId belongs to a different connection"}),(0,t.jsx)(n.td,{children:"ERR_SASLFAIL (904)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Unsupported JWS algorithm"}),(0,t.jsx)(n.td,{children:"ERR_SASLFAIL (904)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Signature verification failure"}),(0,t.jsx)(n.td,{children:"ERR_SASLFAIL (904)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Nonce or timestamp mismatch"}),(0,t.jsx)(n.td,{children:"ERR_SASLFAIL (904)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"aud mismatch"}),(0,t.jsx)(n.td,{children:"ERR_SASLFAIL (904)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Inline challenge expired"}),(0,t.jsx)(n.td,{children:"ERR_SASLFAIL (904)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Pre-issued challenge expired"}),(0,t.jsx)(n.td,{children:"ERR_SASLFAIL (904)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"DID associated with a different account"}),(0,t.jsx)(n.td,{children:"ERR_SASLFAIL (904)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"No account and no auto-registration"}),(0,t.jsx)(n.td,{children:"ERR_SASLFAIL (904)"})]})]})]}),"\n",(0,t.jsx)(n.p,{children:"Servers MUST NOT distinguish between these conditions in the ERR_SASLFAIL message text\nin order to avoid leaking information about account existence or document state."}),"\n",(0,t.jsx)(n.h2,{id:"security-considerations",children:"Security Considerations"}),"\n",(0,t.jsx)(n.h3,{id:"nonce-freshness",children:"Nonce Freshness"}),"\n",(0,t.jsx)(n.p,{children:"Nonces MUST be generated using a cryptographically secure random source. Nonces MUST be\nsingle-use and MUST be consumed on first verification attempt regardless of success or\nfailure. A consumed nonce MUST NOT be reissued."}),"\n",(0,t.jsx)(n.h3,{id:"challenge-binding",children:"Challenge Binding"}),"\n",(0,t.jsxs)(n.p,{children:["Pre-issued challenges are bound to the connection that requested them. Servers MUST\nreject a pre-issued challenge presented on a different connection than the one that\ncalled ",(0,t.jsx)(n.code,{children:"DIDCHALLENGE REQUEST"}),". This prevents challenge theft by a third party who\nintercepts a challenge-id."]}),"\n",(0,t.jsx)(n.h3,{id:"aud-binding",children:"aud Binding"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"aud"})," claim in the JWS payload binds the signature to a specific IRC server hostname,\npreventing cross-server replay. Servers MUST validate this claim. Clients in the delegate\nflow MUST include the IRC server's hostname in the payload they send to the signing\nprovider; providers SHOULD surface this value to the user during consent."]}),"\n",(0,t.jsx)(n.h3,{id:"delegate-flow-considerations",children:"Delegate Flow Considerations"}),"\n",(0,t.jsxs)(n.p,{children:["In the delegate flow the signing provider sees the IRC nonce and could, in principle,\nreplay the signed JWS against the IRC server within the ",(0,t.jsx)(n.code,{children:"DIDPREISSUETTL"})," window. Clients\nSHOULD use providers they trust. Clients SHOULD use PAR with the ",(0,t.jsx)(n.code,{children:"irc_challenge_nonce"}),"\nparameter and DPoP token binding when supported by the provider to reduce the window\nfor provider-side misuse."]}),"\n",(0,t.jsxs)(n.p,{children:["The extended ",(0,t.jsx)(n.code,{children:"DIDPREISSUETTL"})," window compared to ",(0,t.jsx)(n.code,{children:"DIDINLINETTL"})," is a deliberate\ntrade-off: it accommodates interactive OAuth flows at the cost of a larger replay window.\nServers that are highly sensitive to replay risk MAY configure ",(0,t.jsx)(n.code,{children:"DIDPREISSUETTL"})," lower\nthan the default, accepting that some OAuth flows may time out."]}),"\n",(0,t.jsx)(n.h3,{id:"did-document-injection",children:"DID Document Injection"}),"\n",(0,t.jsxs)(n.p,{children:["Servers MUST compare the ",(0,t.jsx)(n.code,{children:"id"})," field of a resolved document to the requested DID using\nexact string equality. Servers MUST NOT accept a document whose ",(0,t.jsx)(n.code,{children:"id"})," differs from the\nrequested DID even by case or Unicode normalisation."]}),"\n",(0,t.jsx)(n.h3,{id:"key-compromise",children:"Key Compromise"}),"\n",(0,t.jsx)(n.p,{children:"If a user's private key (or the signing provider's key) is compromised, an attacker can\nauthenticate until the key is rotated and the server's cache expires. Users SHOULD rotate\nkeys promptly on suspected compromise and notify server operators so that cached documents\nmay be invalidated out-of-band."}),"\n",(0,t.jsx)(n.h2,{id:"examples",children:"Examples"}),"\n",(0,t.jsx)(n.h3,{id:"direct-flow-did-web",children:"Direct flow: DID-WEB"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"C: CAP LS 302\nS: CAP * LS :sasl=PLAIN,DID-WEB,DID-PLC rsr.chat/sasl-did\nC: CAP REQ :sasl rsr.chat/sasl-did\nS: CAP * ACK :sasl rsr.chat/sasl-did\nC: AUTHENTICATE DID-WEB\nS: AUTHENTICATE +\nC: AUTHENTICATE eyJmbG93IjoiZGlyZWN0IiwiZGlkIjoiZGlkOndlYjphbGljZS5leGFtcGxlLmNvbSIsInZtSWQiOiJkaWQ6d2ViOmFsaWNlLmV4YW1wbGUuY29tI2tleS0xIn0=\n(server resolves https://alice.example.com/.well-known/did.json, issues inline challenge)\nS: AUTHENTICATE eyJjaGFsbGVuZ2VJZCI6bnVsbCwibm9uY2UiOiJyYW5kb21ub25jZWJhc2U2NHVybCIsImRpZCI6ImRpZDp3ZWI6YWxpY2UuZXhhbXBsZS5jb20iLCJ2bUlkIjoiZGlkOndlYjphbGljZS5leGFtcGxlLmNvbSNrZXktMSIsInRzIjoiMjAyNC0wMy0xNVQxNDoyMjowMS4wMDBaIiwidHRsIjo2MH0=\nC: AUTHENTICATE <base64-encoded JWS signed by alice's local key>\nS: :server 903 alice :Authentication successful\nS: 001 alice :Welcome to the network\nS: 005 alice DIDDNSTIMEOUT=5000 DIDNONCELEN=32 DIDCACHETTL=300 DIDINLINETTL=60 DIDPREISSUETTL=600 DIDALGS=EdDSA,ES256K,ES256 :are supported by this server\n"})}),"\n",(0,t.jsx)(n.h3,{id:"delegate-flow-did-plc-via-at-protocol-pds",children:"Delegate flow: DID-PLC via AT Protocol PDS"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'(before starting SASL, the client pre-requests a challenge)\nC: DIDCHALLENGE REQUEST did:plc:ewvi7nxzyoun6zhhandbv25b\n(server resolves https://plc.directory/did:plc:ewvi7nxzyoun6zhhandbv25b)\nS: :server RPL_DIDCHALLENGE alice ch_01HQ7K2N4R8VXJ did:plc:ewvi7nxzyoun6zhhandbv25b :eyJjaGFsbGVuZ2VJZCI6ImNoXzAxSFE3SzJONFI4VlhKIiwibm9uY2UiOiJyYW5kb21ub25jZSIsInRzIjoiMjAyNC0wMy0xNVQxNDoyMjowMS4wMDBaIiwidHRsIjo2MDB9\n\n(client now initiates OAuth 2.0 + PKCE flow against the AT Protocol PDS)\n(PDS consent screen shows: "IRC server irc.example.net is requesting a signature\n    for challenge nonce aBcDeFgH... issued at 2024-03-15T14:22:01Z")\n(user approves; client receives access token and calls PDS signing API)\n(PDS returns signed JWS; entire OAuth + signing round-trip takes ~25 seconds)\n\n(client now begins SASL)\nC: AUTHENTICATE DID-PLC\nS: AUTHENTICATE +\nC: AUTHENTICATE eyJmbG93IjoiZGVsZWdhdGUiLCJkaWQiOiJkaWQ6cGxjOmV3dmk3bnh6eW91bjZ6aGhhbmRidjI1YiIsInZtSWQiOiJkaWQ6cGxjOmV3dmk3bnh6eW91bjZ6aGhhbmRidjI1YiNhdGpwcm90b0Jsa0UiLCJjaGFsbGVuZ2VJZCI6ImNoXzAxSFE3SzJONFI4VlhKIn0=\n(server locates pre-issued challenge ch_01HQ7K2N4R8VXJ, confirms not expired,\n    echoes it back)\nS: AUTHENTICATE eyJjaGFsbGVuZ2VJZCI6ImNoXzAxSFE3SzJONFI4VlhKIiwibm9uY2UiOiJyYW5kb21ub25jZSIsImRpZCI6ImRpZDpwbGM6ZXd2aTdueHp5b3VuNnpoaGFuZGJ2MjViIiwidm1JZCI6Ii4uLiIsInRzIjoiMjAyNC0wMy0xNVQxNDoyMjowMS4wMDBaIiwidHRsIjo1NzV9\nC: AUTHENTICATE <base64-encoded JWS returned by the AT Protocol PDS signing API>\nS: :server 903 alice :Authentication successful\n'})}),"\n",(0,t.jsx)(n.h3,{id:"pre-issued-challenge-cancelled-after-failed-oauth-flow",children:"Pre-issued challenge cancelled after failed OAuth flow"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"C: DIDCHALLENGE REQUEST did:web:alice.example.com\nS: :server RPL_DIDCHALLENGE alice ch_01HQAB3T2F cancelled\n(OAuth flow fails at provider; client cleans up)\nC: DIDCHALLENGE CANCEL ch_01HQAB3T2F\n(server discards the challenge)\n"})}),"\n",(0,t.jsx)(n.h3,{id:"whois-showing-authenticated-did-and-flow",children:"WHOIS showing authenticated DID and flow"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"C: WHOIS alice\nS: :server 311 bob alice ~alice alice.example.com * :Alice\nS: :server RPL_WHOISDID bob alice :did:plc:ewvi7nxzyoun6zhhandbv25b\nS: :server 318 bob alice :End of /WHOIS list\n"})}),"\n",(0,t.jsx)(n.h3,{id:"resolution-failure-during-didchallenge-request",children:"Resolution failure during DIDCHALLENGE REQUEST"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"C: DIDCHALLENGE REQUEST did:web:unreachable.example.com\nS: :server ERR_DIDCHALLENGEFAIL alice :DID document could not be resolved\n"})}),"\n",(0,t.jsx)(n.h3,{id:"expired-pre-issued-challenge-presented-in-sasl",children:"Expired pre-issued challenge presented in SASL"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"(challenge ch_01HQ7K issued 620 seconds ago; DIDPREISSUETTL=600)\nC: AUTHENTICATE DID-WEB\nS: AUTHENTICATE +\nC: AUTHENTICATE <initial message referencing ch_01HQ7K>\nS: :server 904 alice :SASL authentication failed\n"})}),"\n",(0,t.jsx)(n.h3,{id:"challenge-presented-on-wrong-connection",children:"Challenge presented on wrong connection"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"(ch_01HQCD was issued on a different connection)\nC: AUTHENTICATE DID-WEB\nS: AUTHENTICATE +\nC: AUTHENTICATE <initial message referencing ch_01HQCD>\nS: :server 904 alice :SASL authentication failed\n"})})]})}function h(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},8453(e,n,i){i.d(n,{R:()=>r,x:()=>l});var s=i(6540);const t={},d=s.createContext(t);function r(e){const n=s.useContext(d);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),s.createElement(d.Provider,{value:n},e.children)}}}]);